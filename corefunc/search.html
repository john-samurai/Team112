<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Search & Management - Monash Bird Buddies</title>
    <link rel="stylesheet" href="../shared/css/common.css" />
    <link rel="stylesheet" href="css/corefunc.css" />
    <!-- Cognito Authentication -->
    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.1485.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/amazon-cognito-identity-js@6.3.12/dist/amazon-cognito-identity.min.js"></script>

    <!-- DEBUG: Strong inline styles with !important to override any conflicts -->
    <style>
      .debug-sub-nav {
        background: #f9fafb !important;
        border-bottom: 2px solid #e5e7eb !important;
        padding: 1rem 0 !important;
        margin: 0 !important;
        position: relative !important;
        z-index: 999 !important;
        width: 100% !important;
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
      }

      .debug-sub-nav-container {
        max-width: 1200px !important;
        margin: 0 auto !important;
        padding: 0 2rem !important;
        width: 100% !important;
        display: block !important;
      }

      .debug-sub-nav-links {
        display: flex !important;
        gap: 2rem !important;
        flex-wrap: wrap !important;
        list-style: none !important;
        margin: 0 !important;
        padding: 0 !important;
      }

      .debug-sub-nav-links a {
        color: #6b7280 !important;
        text-decoration: none !important;
        font-weight: 500 !important;
        padding: 0.75rem 1rem !important;
        border-bottom: 3px solid transparent !important;
        transition: all 0.2s !important;
        white-space: nowrap !important;
        display: inline-block !important;
        font-size: 14px !important;
        border-radius: 4px 4px 0 0 !important;
      }

      .debug-sub-nav-links a:hover,
      .debug-sub-nav-links a.active {
        color: #2563eb !important;
        border-bottom-color: #2563eb !important;
        background: rgba(37, 99, 235, 0.1) !important;
      }

      .debug-sub-nav-links a.active {
        font-weight: 600 !important;
      }

      .main-layout {
        padding-top: 5rem !important;
        min-height: 100vh !important;
      }
    </style>
  </head>
  <body>
    <nav class="navbar">
      <div class="nav-container">
        <a href="../index.html" class="logo">MBB</a>
        <div class="nav-links">
          <a href="upload.html">File Upload</a>
          <a href="search.html">Search & Management</a>
          <a href="settings.html">Settings</a>
          <a href="#" onclick="showSignOutModal()">Sign out</a>
        </div>
      </div>
    </nav>

    <!-- DEBUG SUB-NAVIGATION - This should definitely be visible now -->
    <div class="debug-sub-nav">
      <div class="debug-sub-nav-container">
        <div class="debug-sub-nav-links">
          <a href="#" data-search-type="tags-counts" class="active"
            >Images/Videos Search by Tags & Counts</a
          >
          <a href="#" data-search-type="tags">Search by Tags</a>
          <a href="#" data-search-type="thumbnail-url"
            >Search by Thumbnail URL</a
          >
          <a href="#" data-search-type="file-upload">Search by File Upload</a>
        </div>
      </div>
    </div>

    <div class="main-layout">
      <div class="container">
        <h1 class="page-title">Search & Management</h1>

        <!-- Debug info -->
        <div
          style="
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 0.5rem;
          ">
          <strong>DEBUG:</strong> If you can see this message but not the
          sub-navigation above, there might be a CSS loading issue.
          <br />
          <strong>Current active tab:</strong>
          <span id="currentTabDebug">tags-counts</span>
        </div>

        <!-- Images/Videos Search by Tags & Counts -->
        <div class="search-form" id="tags-counts-form">
          <h2 class="search-form-title">Search by Tags & Counts</h2>
          <p class="search-form-description">
            Find images and videos that contain specific bird species with
            minimum counts.
          </p>

          <div class="tag-count-pairs" id="tagCountPairs">
            <div class="tag-count-pair">
              <select class="tag-select">
                <option value="">Select bird species</option>
                <option value="crow">Crow</option>
                <option value="pigeon">Pigeon</option>
                <option value="sparrow">Sparrow</option>
                <option value="robin">Robin</option>
              </select>
              <input
                type="number"
                class="count-input"
                placeholder="Count"
                min="1" />
              <button
                class="btn-remove-tag"
                onclick="this.parentElement.remove()">
                √ó Remove
              </button>
            </div>
          </div>

          <div class="search-form-actions">
            <button class="btn-add-tag" onclick="addTagCountPair()">
              + Add Tag
            </button>
            <button class="btn-submit" onclick="searchByTagsAndCounts()">
              Search
            </button>
            <button class="btn-secondary" onclick="resetTagsCountsForm()">
              Reset
            </button>
          </div>
        </div>

        <!-- Search by Tags -->
        <div class="search-form" id="tags-form" style="display: none">
          <h2 class="search-form-title">Search by Tags</h2>
          <p class="search-form-description">
            Find all files containing specific bird species (any count).
          </p>

          <div class="species-selection">
            <label for="speciesSelect" class="form-label"
              >Select bird species:</label
            >
            <select id="speciesSelect" class="species-select" multiple>
              <option value="crow">Crow</option>
              <option value="pigeon">Pigeon</option>
              <option value="sparrow">Sparrow</option>
              <option value="robin">Robin</option>
            </select>
            <small class="form-help"
              >Hold Ctrl/Cmd to select multiple species</small
            >
          </div>

          <div class="search-form-actions">
            <button class="btn-submit" onclick="searchByTags()">Search</button>
            <button class="btn-secondary" onclick="clearTagsForm()">
              Clear
            </button>
          </div>
        </div>

        <!-- Search by Thumbnail URL -->
        <div class="search-form" id="thumbnail-url-form" style="display: none">
          <h2 class="search-form-title">Search by Thumbnail URL</h2>
          <p class="search-form-description">
            Enter an S3 thumbnail URL to get the corresponding full-size image.
          </p>

          <div class="url-input-section">
            <label for="thumbnailUrl" class="form-label"
              >S3 Thumbnail URL:</label
            >
            <input
              type="url"
              id="thumbnailUrl"
              class="url-input"
              placeholder="https://xxx.s3.amazonaws.com/bird1-thumb.png" />
            <small class="form-help"
              >Example: https://xxx.s3.amazonaws.com/bird1-thumb.png</small
            >
          </div>

          <div class="search-form-actions">
            <button class="btn-submit" onclick="searchByThumbnailUrl()">
              Search
            </button>
            <button class="btn-secondary" onclick="clearThumbnailForm()">
              Clear
            </button>
          </div>
        </div>

        <!-- Search by File Upload -->
        <div class="search-form" id="file-upload-form" style="display: none">
          <h2 class="search-form-title">Search by File Upload</h2>
          <p class="search-form-description">
            Upload a file to find similar files based on detected bird species.
          </p>

          <div class="search-upload-area" id="searchUploadArea">
            <div class="upload-icon">üìÅ</div>
            <p class="upload-text">Drag & drop file here or</p>
            <button
              class="btn-choose-file"
              onclick="document.getElementById('searchFileInput').click()">
              Choose File
            </button>
            <p class="upload-warning">
              ‚ö†Ô∏è Note: File will not be stored - used for tag matching only
            </p>
            <input
              type="file"
              id="searchFileInput"
              class="file-input"
              accept=".jpg,.jpeg,.png,.wav,.mp3,.mp4" />
          </div>

          <div class="search-form-actions">
            <button
              class="btn-submit"
              onclick="searchByFileUpload()"
              id="searchByFileBtn"
              disabled>
              Search
            </button>
            <button class="btn-secondary" onclick="clearFileUploadForm()">
              Clear
            </button>
          </div>
        </div>

        <!-- Search Results Section -->
        <div
          class="search-results-section"
          id="searchResultsSection"
          style="display: none">
          <div class="results-header">
            <h3 class="results-title" id="resultsTitle">Search Results</h3>
            <p class="results-count" id="resultsCount">Found 0 files</p>
          </div>

          <div class="results-grid" id="searchResults">
            <!-- Results will be populated here -->
          </div>
        </div>

        <!-- Floating Action Bar -->
        <div class="floating-action-bar hidden" id="floatingActionBar">
          <span id="selectedCount">0 files selected</span>
          <button class="btn-action" onclick="showAddTagsModal()">
            Add Tags
          </button>
          <button class="btn-action" onclick="showRemoveTagsModal()">
            Remove Tags
          </button>
          <button
            class="btn-action btn-danger"
            onclick="showDeleteFilesModal()">
            Delete Files
          </button>
        </div>
      </div>
    </div>

    <!-- Sign Out Modal -->
    <div class="modal" id="signOutModal">
      <div class="modal-content">
        <h3 class="modal-title">Are you sure you want to sign out?</h3>
        <div class="modal-buttons">
          <button class="btn-submit" onclick="signOut()">Yes</button>
          <button class="btn-secondary" onclick="hideSignOutModal()">No</button>
        </div>
      </div>
    </div>

    <script src="../shared/js/common.js"></script>
    <script>
      // DEBUG: Enhanced search.js with debugging
      let selectedFiles = [];
      let currentSearchResults = [];
      let searchUploadedFile = null;

      // Initialize search functionality with debugging
      function initializeSearch() {
        console.log("DEBUG: Initializing search functionality");

        const searchTabs = document.querySelectorAll(".debug-sub-nav-links a");
        console.log("DEBUG: Found", searchTabs.length, "search tabs");

        searchTabs.forEach((tab, index) => {
          console.log("DEBUG: Setting up tab", index, tab.textContent);
          tab.addEventListener("click", (e) => {
            e.preventDefault();
            console.log(
              "DEBUG: Tab clicked:",
              tab.getAttribute("data-search-type")
            );

            searchTabs.forEach((t) => t.classList.remove("active"));
            tab.classList.add("active");

            // Show corresponding search form
            const searchType = tab.getAttribute("data-search-type");
            showSearchForm(searchType);

            // Update debug info
            document.getElementById("currentTabDebug").textContent = searchType;
          });
        });

        // Initialize file upload for search
        initializeSearchFileUpload();

        // Show the first form by default
        showSearchForm("tags-counts");
      }

      // Show specific search form
      function showSearchForm(searchType) {
        console.log("DEBUG: Showing search form:", searchType);

        // Hide all search forms
        document.querySelectorAll(".search-form").forEach((form) => {
          form.style.display = "none";
        });

        // Show selected form
        const selectedForm = document.getElementById(`${searchType}-form`);
        if (selectedForm) {
          selectedForm.style.display = "block";
          console.log("DEBUG: Form shown:", searchType);
        } else {
          console.error("DEBUG: Form not found:", searchType);
        }

        // Hide results when switching forms
        hideSearchResults();
        clearSelection();
      }

      // Simplified functions for debugging
      function addTagCountPair() {
        const container = document.getElementById("tagCountPairs");
        const pairDiv = document.createElement("div");
        pairDiv.className = "tag-count-pair";
        pairDiv.innerHTML = `
          <select class="tag-select">
            <option value="">Select bird species</option>
            <option value="crow">Crow</option>
            <option value="pigeon">Pigeon</option>
            <option value="sparrow">Sparrow</option>
            <option value="robin">Robin</option>
          </select>
          <input type="number" class="count-input" placeholder="Count" min="1">
          <button class="btn-remove-tag" onclick="this.parentElement.remove()">√ó Remove</button>
        `;
        container.appendChild(pairDiv);
      }

      function resetTagsCountsForm() {
        const container = document.getElementById("tagCountPairs");
        container.innerHTML = `
          <div class="tag-count-pair">
            <select class="tag-select">
              <option value="">Select bird species</option>
              <option value="crow">Crow</option>
              <option value="pigeon">Pigeon</option>
              <option value="sparrow">Sparrow</option>
              <option value="robin">Robin</option>
            </select>
            <input type="number" class="count-input" placeholder="Count" min="1">
            <button class="btn-remove-tag" onclick="this.parentElement.remove()">√ó Remove</button>
          </div>
        `;
        hideSearchResults();
      }

      function clearTagsForm() {
        document.getElementById("speciesSelect").selectedIndex = -1;
        hideSearchResults();
      }

      function clearThumbnailForm() {
        document.getElementById("thumbnailUrl").value = "";
        hideSearchResults();
      }

      function clearFileUploadForm() {
        document.getElementById("searchFileInput").value = "";
        document.getElementById("searchByFileBtn").disabled = true;
        searchUploadedFile = null;
        hideSearchResults();
      }

      function searchByTagsAndCounts() {
        alert(
          "Search by Tags & Counts functionality - will be implemented with backend"
        );
      }

      function searchByTags() {
        alert(
          "Search by Tags functionality - will be implemented with backend"
        );
      }

      function searchByThumbnailUrl() {
        alert(
          "Search by Thumbnail URL functionality - will be implemented with backend"
        );
      }

      function searchByFileUpload() {
        alert(
          "Search by File Upload functionality - will be implemented with backend"
        );
      }

      function hideSearchResults() {
        const section = document.getElementById("searchResultsSection");
        if (section) {
          section.style.display = "none";
        }
      }

      function clearSelection() {
        selectedFiles = [];
      }

      function initializeSearchFileUpload() {
        const fileInput = document.getElementById("searchFileInput");
        if (fileInput) {
          fileInput.addEventListener("change", (e) => {
            const file = e.target.files[0];
            if (file) {
              searchUploadedFile = file;
              document.getElementById("searchByFileBtn").disabled = false;
            }
          });
        }
      }

      function showSignOutModal() {
        const modal = document.getElementById("signOutModal");
        if (modal) {
          modal.classList.add("active");
        }
      }

      function hideSignOutModal() {
        const modal = document.getElementById("signOutModal");
        if (modal) {
          modal.classList.remove("active");
        }
      }

      function signOut() {
        // Implement sign out logic
        alert("Sign out functionality");
      }

      // Initialize on page load
      document.addEventListener("DOMContentLoaded", () => {
        console.log("DEBUG: Page loaded, initializing search");
        initializeSearch();
      });
    </script>
  </body>
</html>
