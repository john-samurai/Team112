<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Search & Management - Monash Bird Buddies</title>
    <link rel="stylesheet" href="../shared/css/common.css" />
    <link rel="stylesheet" href="css/corefunc.css" />
    <!-- Cognito Authentication -->
    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.1485.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/amazon-cognito-identity-js@6.3.12/dist/amazon-cognito-identity.min.js"></script>

    <!-- FORCE SUB-NAV TO BE VISIBLE -->
    <style>
      /* Override any conflicting styles */
      .force-subnav-visible {
        position: relative !important;
        top: 0 !important;
        left: 0 !important;
        right: 0 !important;
        width: 100% !important;
        background: #f8fafc !important;
        border-bottom: 2px solid #e2e8f0 !important;
        padding: 1rem 0 !important;
        margin: 0 !important;
        z-index: 999 !important;
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
        height: auto !important;
      }

      .force-subnav-container {
        max-width: 1200px !important;
        margin: 0 auto !important;
        padding: 0 2rem !important;
        display: block !important;
      }

      .force-subnav-links {
        display: flex !important;
        gap: 1.5rem !important;
        flex-wrap: wrap !important;
        justify-content: flex-start !important;
      }

      .force-subnav-links a {
        display: inline-block !important;
        color: #64748b !important;
        text-decoration: none !important;
        font-weight: 500 !important;
        padding: 0.75rem 1rem !important;
        border-bottom: 3px solid transparent !important;
        transition: all 0.2s ease !important;
        white-space: nowrap !important;
        border-radius: 0.5rem 0.5rem 0 0 !important;
        background: transparent !important;
      }

      .force-subnav-links a:hover,
      .force-subnav-links a.active {
        color: #2563eb !important;
        border-bottom-color: #2563eb !important;
        background: rgba(37, 99, 235, 0.1) !important;
      }

      .force-subnav-links a.active {
        font-weight: 600 !important;
      }

      /* Ensure main content starts below sub-nav */
      .main-layout {
        padding-top: 6rem !important; /* Extra space for sub-nav */
        min-height: 100vh !important;
      }

      /* Debug border to make sub-nav visible */
      .debug-border {
        border: 3px solid red !important;
        background: yellow !important;
      }
    </style>
  </head>
  <body>
    <nav class="navbar">
      <div class="nav-container">
        <a href="../index.html" class="logo">MBB</a>
        <div class="nav-links">
          <a href="upload.html">File Upload</a>
          <a href="search.html">Search & Management</a>
          <a href="settings.html">Settings</a>
          <a href="#" onclick="showSignOutModal()">Sign out</a>
        </div>
      </div>
    </nav>

    <!-- FORCED VISIBLE SUB-NAVIGATION -->
    <div class="force-subnav-visible debug-border">
      <div class="force-subnav-container">
        <div class="force-subnav-links">
          <a href="#" data-search-type="tags-counts" class="active"
            >Images/Videos Search by Tags & Counts</a
          >
          <a href="#" data-search-type="tags">Search by Tags</a>
          <a href="#" data-search-type="thumbnail-url"
            >Search by Thumbnail URL</a
          >
          <a href="#" data-search-type="file-upload">Search by File Upload</a>
        </div>
      </div>
    </div>

    <div class="main-layout">
      <div class="container">
        <h1 class="page-title">Search & Management</h1>

        <!-- Debug info -->
        <div
          style="
            background: #e0f2fe;
            border: 2px solid #0891b2;
            padding: 1rem;
            margin-bottom: 2rem;
            border-radius: 0.5rem;
          ">
          <strong>üîç DEBUG:</strong> Can you see the yellow sub-navigation bar
          with red border above this message?<br />
          <strong>Current tab:</strong>
          <span id="debugCurrentTab">tags-counts</span>
        </div>

        <!-- Images/Videos Search by Tags & Counts -->
        <div class="search-form" id="tags-counts-form">
          <h2 class="search-form-title">Search by Tags & Counts</h2>
          <p class="search-form-description">
            Find images and videos that contain specific bird species with
            minimum counts.
          </p>

          <div class="tag-count-pairs" id="tagCountPairs">
            <div class="tag-count-pair">
              <select class="tag-select">
                <option value="">Select bird species</option>
                <option value="crow">Crow</option>
                <option value="pigeon">Pigeon</option>
                <option value="sparrow">Sparrow</option>
                <option value="robin">Robin</option>
              </select>
              <input
                type="number"
                class="count-input"
                placeholder="Count"
                min="1" />
              <button
                class="btn-remove-tag"
                onclick="this.parentElement.remove()">
                √ó Remove
              </button>
            </div>
          </div>

          <div class="search-form-actions">
            <button class="btn-add-tag" onclick="addTagCountPair()">
              + Add Tag
            </button>
            <button class="btn-submit" onclick="searchByTagsAndCounts()">
              Search
            </button>
            <button class="btn-secondary" onclick="resetTagsCountsForm()">
              Reset
            </button>
          </div>
        </div>

        <!-- Search by Tags -->
        <div class="search-form" id="tags-form" style="display: none">
          <h2 class="search-form-title">Search by Tags</h2>
          <p class="search-form-description">
            Find all files containing specific bird species (any count).
          </p>

          <div class="species-selection">
            <label for="speciesSelect" class="form-label"
              >Select bird species:</label
            >
            <select id="speciesSelect" class="species-select" multiple>
              <option value="crow">Crow</option>
              <option value="pigeon">Pigeon</option>
              <option value="sparrow">Sparrow</option>
              <option value="robin">Robin</option>
            </select>
            <small class="form-help"
              >Hold Ctrl/Cmd to select multiple species</small
            >
          </div>

          <div class="search-form-actions">
            <button class="btn-submit" onclick="searchByTags()">Search</button>
            <button class="btn-secondary" onclick="clearTagsForm()">
              Clear
            </button>
          </div>
        </div>

        <!-- Search by Thumbnail URL -->
        <div class="search-form" id="thumbnail-url-form" style="display: none">
          <h2 class="search-form-title">Search by Thumbnail URL</h2>
          <p class="search-form-description">
            Enter an S3 thumbnail URL to get the corresponding full-size image.
          </p>

          <div class="url-input-section">
            <label for="thumbnailUrl" class="form-label"
              >S3 Thumbnail URL:</label
            >
            <input
              type="url"
              id="thumbnailUrl"
              class="url-input"
              placeholder="https://xxx.s3.amazonaws.com/bird1-thumb.png" />
            <small class="form-help"
              >Example: https://xxx.s3.amazonaws.com/bird1-thumb.png</small
            >
          </div>

          <div class="search-form-actions">
            <button class="btn-submit" onclick="searchByThumbnailUrl()">
              Search
            </button>
            <button class="btn-secondary" onclick="clearThumbnailForm()">
              Clear
            </button>
          </div>
        </div>

        <!-- Search by File Upload -->
        <div class="search-form" id="file-upload-form" style="display: none">
          <h2 class="search-form-title">Search by File Upload</h2>
          <p class="search-form-description">
            Upload a file to find similar files based on detected bird species.
          </p>

          <div class="search-upload-area" id="searchUploadArea">
            <div class="upload-icon">üìÅ</div>
            <p class="upload-text">Drag & drop file here or click to select</p>
            <p class="upload-subtext">
              ‚ö†Ô∏è Note: File will not be stored - used for tag matching only
            </p>
            <input
              type="file"
              id="searchFileInput"
              class="file-input"
              accept=".jpg,.jpeg,.png,.wav,.mp3,.mp4" />
          </div>

          <div class="search-form-actions">
            <button
              class="btn-submit"
              onclick="searchByFileUpload()"
              id="searchByFileBtn"
              disabled>
              Search
            </button>
            <button class="btn-secondary" onclick="clearFileUploadForm()">
              Clear
            </button>
          </div>
        </div>

        <!-- Search Results Section -->
        <div
          class="search-results-section"
          id="searchResultsSection"
          style="display: none">
          <div class="results-header">
            <h3 class="results-title" id="resultsTitle">Search Results</h3>
            <p class="results-count" id="resultsCount">Found 0 files</p>
          </div>
          <div class="results-grid" id="searchResults"></div>
        </div>

        <!-- Floating Action Bar -->
        <div class="floating-action-bar hidden" id="floatingActionBar">
          <span id="selectedCount">0 files selected</span>
          <button class="btn-action" onclick="showAddTagsModal()">
            Add Tags
          </button>
          <button class="btn-action" onclick="showRemoveTagsModal()">
            Remove Tags
          </button>
          <button
            class="btn-action btn-danger"
            onclick="showDeleteFilesModal()">
            Delete Files
          </button>
        </div>
      </div>
    </div>

    <!-- Add Tags Modal -->
    <div class="modal" id="addTagsModal">
      <div class="modal-content modal-large">
        <h3 class="modal-title">Add Tags to Selected Files</h3>
        <hr class="modal-divider" />
        <p class="modal-info">
          Selected Files: <span id="addTagsFileCount">0</span> files
        </p>
        <div class="modal-section">
          <h4>Add New Tags:</h4>
          <div class="tag-count-pairs" id="addTagsPairs">
            <div class="tag-count-pair">
              <select class="tag-select">
                <option value="">Select bird species</option>
                <option value="crow">Crow</option>
                <option value="pigeon">Pigeon</option>
                <option value="sparrow">Sparrow</option>
                <option value="robin">Robin</option>
              </select>
              <input
                type="number"
                class="count-input"
                placeholder="Count"
                min="1" />
              <button
                class="btn-remove-tag"
                onclick="this.parentElement.remove()">
                √ó Remove
              </button>
            </div>
          </div>
          <button
            class="btn-add-tag"
            onclick="addTagPairToModal('addTagsPairs')">
            + Add Another Tag
          </button>
        </div>
        <div class="modal-preview">
          <strong>Preview:</strong> <span id="addTagsPreview">{}</span>
        </div>
        <hr class="modal-divider" />
        <div class="modal-buttons">
          <button class="btn-secondary" onclick="hideAddTagsModal()">
            Cancel
          </button>
          <button class="btn-submit" onclick="applyAddTags()">
            Apply Tags
          </button>
        </div>
      </div>
    </div>

    <!-- Remove Tags Modal -->
    <div class="modal" id="removeTagsModal">
      <div class="modal-content modal-large">
        <h3 class="modal-title">Remove Tags from Selected Files</h3>
        <hr class="modal-divider" />
        <p class="modal-info">
          Selected Files: <span id="removeTagsFileCount">0</span> files
        </p>
        <div class="modal-section">
          <h4>Current Tags in Selected Files:</h4>
          <div class="current-tags" id="currentTagsDisplay"></div>
        </div>
        <div class="modal-section">
          <h4>Or specify tags to remove:</h4>
          <div class="tag-count-pairs" id="removeTagsPairs">
            <div class="tag-count-pair">
              <select class="tag-select">
                <option value="">Select bird species</option>
                <option value="crow">Crow</option>
                <option value="pigeon">Pigeon</option>
                <option value="sparrow">Sparrow</option>
                <option value="robin">Robin</option>
              </select>
              <input
                type="number"
                class="count-input"
                placeholder="Count"
                min="1" />
              <button
                class="btn-remove-tag"
                onclick="this.parentElement.remove()">
                √ó Remove
              </button>
            </div>
          </div>
          <button
            class="btn-add-tag"
            onclick="addTagPairToModal('removeTagsPairs')">
            + Add Tag to Remove
          </button>
        </div>
        <div class="modal-preview">
          <strong>Preview:</strong> <span id="removeTagsPreview">{}</span>
        </div>
        <hr class="modal-divider" />
        <div class="modal-buttons">
          <button class="btn-secondary" onclick="hideRemoveTagsModal()">
            Cancel
          </button>
          <button class="btn-submit" onclick="applyRemoveTags()">
            Remove Tags
          </button>
        </div>
      </div>
    </div>

    <!-- Delete Files Modal -->
    <div class="modal" id="deleteFilesModal">
      <div class="modal-content modal-large">
        <h3 class="modal-title">Delete Files</h3>
        <hr class="modal-divider" />
        <div class="warning-section">
          <p class="warning-text">‚ö†Ô∏è Warning: This action cannot be undone</p>
        </div>
        <div class="modal-section">
          <p>
            You are about to delete <span id="deleteFileCount">0</span> files:
          </p>
          <div class="files-to-delete" id="filesToDeleteList"></div>
        </div>
        <div class="modal-section">
          <p><strong>This will:</strong></p>
          <ul class="action-list">
            <li>‚úì Remove files from S3 storage</li>
            <li>‚úì Remove thumbnails from S3</li>
            <li>‚úì Remove all database entries</li>
          </ul>
        </div>
        <div class="confirmation-section">
          <label for="deleteConfirmation">Type "DELETE" to confirm:</label>
          <input
            type="text"
            id="deleteConfirmation"
            class="confirmation-input"
            placeholder="DELETE" />
        </div>
        <hr class="modal-divider" />
        <div class="modal-buttons">
          <button class="btn-secondary" onclick="hideDeleteFilesModal()">
            Cancel
          </button>
          <button
            class="btn-danger"
            onclick="confirmDeleteFiles()"
            id="confirmDeleteBtn"
            disabled>
            Delete Files
          </button>
        </div>
      </div>
    </div>

    <!-- Sign Out Modal -->
    <div class="modal" id="signOutModal">
      <div class="modal-content">
        <h3 class="modal-title">Are you sure you want to sign out?</h3>
        <div class="modal-buttons">
          <button class="btn-submit" onclick="confirmSignOut()">Yes</button>
          <button class="btn-secondary" onclick="hideSignOutModal()">No</button>
        </div>
      </div>
    </div>

    <script src="../shared/js/common.js"></script>
    <script>
      // Enhanced search.js with debug info
      let selectedFiles = [];
      let currentSearchResults = [];
      let searchUploadedFile = null;

      function initializeSearch() {
        console.log("üîç Initializing search functionality");

        const searchTabs = document.querySelectorAll(".force-subnav-links a");
        console.log("üìã Found", searchTabs.length, "search tabs");

        searchTabs.forEach((tab, index) => {
          const searchType = tab.getAttribute("data-search-type");
          console.log(`üîó Setting up tab ${index + 1}: ${searchType}`);

          tab.addEventListener("click", (e) => {
            e.preventDefault();
            console.log(`üñ±Ô∏è Tab clicked: ${searchType}`);

            searchTabs.forEach((t) => t.classList.remove("active"));
            tab.classList.add("active");
            showSearchForm(searchType);

            // Update debug info
            document.getElementById("debugCurrentTab").textContent = searchType;
          });
        });

        initializeSearchFileUpload();
        initializeDeleteConfirmation();
        showSearchForm("tags-counts");

        console.log("‚úÖ Search initialization complete");
      }

      function showSearchForm(searchType) {
        console.log(`üìÑ Showing search form: ${searchType}`);

        document.querySelectorAll(".search-form").forEach((form) => {
          form.style.display = "none";
        });

        const selectedForm = document.getElementById(`${searchType}-form`);
        if (selectedForm) {
          selectedForm.style.display = "block";
          console.log(`‚úÖ Form ${searchType} is now visible`);
        } else {
          console.error(`‚ùå ERROR: Form ${searchType} not found!`);
        }

        hideSearchResults();
        clearSelection();
      }

      function addTagCountPair() {
        const container = document.getElementById("tagCountPairs");
        const pairDiv = document.createElement("div");
        pairDiv.className = "tag-count-pair";
        pairDiv.innerHTML = `
          <select class="tag-select">
            <option value="">Select bird species</option>
            <option value="crow">Crow</option>
            <option value="pigeon">Pigeon</option>
            <option value="sparrow">Sparrow</option>
            <option value="robin">Robin</option>
          </select>
          <input type="number" class="count-input" placeholder="Count" min="1">
          <button class="btn-remove-tag" onclick="this.parentElement.remove()">√ó Remove</button>
        `;
        container.appendChild(pairDiv);
      }

      function resetTagsCountsForm() {
        const container = document.getElementById("tagCountPairs");
        container.innerHTML = `
          <div class="tag-count-pair">
            <select class="tag-select">
              <option value="">Select bird species</option>
              <option value="crow">Crow</option>
              <option value="pigeon">Pigeon</option>
              <option value="sparrow">Sparrow</option>
              <option value="robin">Robin</option>
            </select>
            <input type="number" class="count-input" placeholder="Count" min="1">
            <button class="btn-remove-tag" onclick="this.parentElement.remove()">√ó Remove</button>
          </div>
        `;
        hideSearchResults();
      }

      function clearTagsForm() {
        document.getElementById("speciesSelect").selectedIndex = -1;
        hideSearchResults();
      }

      function clearThumbnailForm() {
        document.getElementById("thumbnailUrl").value = "";
        hideSearchResults();
      }

      function clearFileUploadForm() {
        document.getElementById("searchFileInput").value = "";
        document.getElementById("searchByFileBtn").disabled = true;
        searchUploadedFile = null;
        hideSearchResults();
      }

      function searchByTagsAndCounts() {
        alert("üîç Search by Tags & Counts - Will connect to backend APIs");
      }

      function searchByTags() {
        alert("üîç Search by Tags - Will connect to backend APIs");
      }

      function searchByThumbnailUrl() {
        alert("üîç Search by Thumbnail URL - Will connect to backend APIs");
      }

      function searchByFileUpload() {
        alert("üîç Search by File Upload - Will connect to backend APIs");
      }

      function hideSearchResults() {
        const section = document.getElementById("searchResultsSection");
        if (section) section.style.display = "none";
      }

      function clearSelection() {
        selectedFiles = [];
      }

      function initializeSearchFileUpload() {
        const fileInput = document.getElementById("searchFileInput");
        if (fileInput) {
          fileInput.addEventListener("change", (e) => {
            const file = e.target.files[0];
            if (file) {
              searchUploadedFile = file;
              document.getElementById("searchByFileBtn").disabled = false;
            }
          });
        }
      }

      function initializeDeleteConfirmation() {
        // Implementation for delete confirmation
      }

      function showAddTagsModal() {
        alert("Add Tags modal - Will be implemented");
      }

      function showRemoveTagsModal() {
        alert("Remove Tags modal - Will be implemented");
      }

      function showDeleteFilesModal() {
        alert("Delete Files modal - Will be implemented");
      }

      function showSignOutModal() {
        const modal = document.getElementById("signOutModal");
        if (modal) modal.classList.add("active");
      }

      function hideSignOutModal() {
        const modal = document.getElementById("signOutModal");
        if (modal) modal.classList.remove("active");
      }

      function confirmSignOut() {
        hideSignOutModal();
        // Clear session and redirect
        sessionStorage.clear();
        window.location.href = "../index.html";
      }

      document.addEventListener("DOMContentLoaded", () => {
        console.log("üåü PAGE LOADED - Starting initialization");
        initializeSearch();
      });
    </script>
  </body>
</html>
