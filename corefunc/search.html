<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Search & Management - Monash Bird Buddies</title>
    <link rel="stylesheet" href="../shared/css/common.css" />
    <link rel="stylesheet" href="css/corefunc.css" />
    <!-- Cognito Authentication -->
    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.1485.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/amazon-cognito-identity-js@6.3.12/dist/amazon-cognito-identity.min.js"></script>

    <style>
      /* FORCE SUB-NAV TO BE VISIBLE */
      .force-visible-subnav {
        position: fixed !important;
        top: 70px !important; /* Below the main navbar */
        left: 0 !important;
        right: 0 !important;
        background: #ffffff !important;
        border: 3px solid #2563eb !important; /* Blue border to make it obvious */
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1) !important;
        z-index: 1000 !important;
        padding: 15px 0 !important;
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
        height: auto !important;
        width: 100% !important;
      }

      .force-visible-container {
        max-width: 1200px !important;
        margin: 0 auto !important;
        padding: 0 2rem !important;
        display: block !important;
      }

      .force-visible-links {
        display: flex !important;
        gap: 1rem !important;
        flex-wrap: wrap !important;
        justify-content: center !important;
        align-items: center !important;
      }

      .force-visible-links a {
        display: inline-block !important;
        background: #f3f4f6 !important;
        color: #374151 !important;
        text-decoration: none !important;
        font-weight: 500 !important;
        padding: 12px 20px !important;
        border-radius: 8px !important;
        border: 2px solid #e5e7eb !important;
        transition: all 0.2s ease !important;
        font-size: 14px !important;
        white-space: nowrap !important;
        cursor: pointer !important;
        min-height: 40px !important;
        line-height: 1.2 !important;
      }

      .force-visible-links a:hover {
        background: #e5e7eb !important;
        border-color: #2563eb !important;
        color: #1f2937 !important;
      }

      .force-visible-links a.active {
        background: #2563eb !important;
        color: #ffffff !important;
        border-color: #1d4ed8 !important;
        font-weight: 600 !important;
      }

      /* Adjust main content to account for fixed subnav */
      .main-layout {
        padding-top: 140px !important; /* More space for fixed subnav */
        min-height: 100vh !important;
      }

      /* Make sure the page title is visible */
      .page-title {
        background: #fbbf24 !important;
        color: #000 !important;
        padding: 1rem !important;
        margin: 1rem 0 !important;
        border-radius: 8px !important;
        text-align: center !important;
      }

      /* Make search forms more visible */
      .search-form {
        background: #ffffff !important;
        border: 2px solid #059669 !important;
        padding: 2rem !important;
        border-radius: 1rem !important;
        margin-bottom: 2rem !important;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1) !important;
      }

      .search-form-title {
        background: #059669 !important;
        color: #ffffff !important;
        padding: 1rem !important;
        margin: -2rem -2rem 1rem -2rem !important;
        border-radius: 1rem 1rem 0 0 !important;
        font-size: 1.5rem !important;
        font-weight: 600 !important;
      }
    </style>
  </head>
  <body>
    <nav class="navbar">
      <div class="nav-container">
        <a href="../index.html" class="logo">MBB</a>
        <div class="nav-links">
          <a href="upload.html">File Upload</a>
          <a href="search.html">Search & Management</a>
          <a href="settings.html">Settings</a>
          <a href="#" onclick="showSignOutModal()">Sign out</a>
        </div>
      </div>
    </nav>

    <!-- FORCED VISIBLE SUB-NAVIGATION -->
    <div class="force-visible-subnav">
      <div class="force-visible-container">
        <div class="force-visible-links">
          <a href="#" data-search-type="tags-counts" class="active"
            >Images/Videos Search by Tags & Counts</a
          >
          <a href="#" data-search-type="tags">Search by Tags</a>
          <a href="#" data-search-type="thumbnail-url"
            >Search by Thumbnail URL</a
          >
          <a href="#" data-search-type="file-upload">Search by File Upload</a>
        </div>
      </div>
    </div>

    <div class="main-layout">
      <div class="container">
        <h1 class="page-title">
          üîç Search & Management - SUB-NAV SHOULD BE VISIBLE ABOVE üîç
        </h1>

        <!-- Images/Videos Search by Tags & Counts -->
        <div class="search-form" id="tags-counts-form">
          <h2 class="search-form-title">üè∑Ô∏è Search by Tags & Counts</h2>
          <p class="search-form-description">
            Find images and videos that contain specific bird species with
            minimum counts.
          </p>

          <div class="tag-count-pairs" id="tagCountPairs">
            <div class="tag-count-pair">
              <select
                class="tag-select"
                style="
                  padding: 0.75rem;
                  border: 2px solid #2563eb;
                  border-radius: 0.5rem;
                  font-size: 1rem;
                ">
                <option value="">Select bird species</option>
                <option value="crow">Crow</option>
                <option value="pigeon">Pigeon</option>
                <option value="sparrow">Sparrow</option>
                <option value="robin">Robin</option>
              </select>
              <input
                type="number"
                class="count-input"
                placeholder="Count"
                min="1"
                style="
                  padding: 0.75rem;
                  border: 2px solid #2563eb;
                  border-radius: 0.5rem;
                  font-size: 1rem;
                  width: 100px;
                " />
              <button
                class="btn-remove-tag"
                onclick="this.parentElement.remove()"
                style="
                  background: #ef4444;
                  color: white;
                  border: none;
                  padding: 0.75rem 1rem;
                  border-radius: 0.5rem;
                  cursor: pointer;
                ">
                √ó Remove
              </button>
            </div>
          </div>

          <div
            class="search-form-actions"
            style="margin-top: 1.5rem; display: flex; gap: 1rem">
            <button
              class="btn-add-tag"
              onclick="addTagCountPair()"
              style="
                background: #2563eb;
                color: white;
                border: none;
                padding: 0.75rem 1.5rem;
                border-radius: 0.5rem;
                cursor: pointer;
                font-weight: 500;
              ">
              + Add Tag
            </button>
            <button
              class="btn-submit"
              onclick="searchByTagsAndCounts()"
              style="
                background: #059669;
                color: white;
                border: none;
                padding: 0.75rem 1.5rem;
                border-radius: 0.5rem;
                cursor: pointer;
                font-weight: 500;
              ">
              Search
            </button>
            <button
              class="btn-secondary"
              onclick="resetTagsCountsForm()"
              style="
                background: #6b7280;
                color: white;
                border: none;
                padding: 0.75rem 1.5rem;
                border-radius: 0.5rem;
                cursor: pointer;
                font-weight: 500;
              ">
              Reset
            </button>
          </div>
        </div>

        <!-- Search by Tags -->
        <div class="search-form" id="tags-form" style="display: none">
          <h2 class="search-form-title">üîñ Search by Tags</h2>
          <p class="search-form-description">
            Find all files containing specific bird species (any count).
          </p>

          <div class="species-selection">
            <label
              for="speciesSelect"
              style="display: block; font-weight: 500; margin-bottom: 0.5rem"
              >Select bird species:</label
            >
            <select
              id="speciesSelect"
              multiple
              style="
                width: 100%;
                padding: 0.75rem;
                border: 2px solid #2563eb;
                border-radius: 0.5rem;
                min-height: 120px;
              ">
              <option value="crow">Crow</option>
              <option value="pigeon">Pigeon</option>
              <option value="sparrow">Sparrow</option>
              <option value="robin">Robin</option>
            </select>
            <small style="color: #6b7280; font-size: 0.875rem"
              >Hold Ctrl/Cmd to select multiple species</small
            >
          </div>

          <div
            class="search-form-actions"
            style="margin-top: 1.5rem; display: flex; gap: 1rem">
            <button
              class="btn-submit"
              onclick="searchByTags()"
              style="
                background: #059669;
                color: white;
                border: none;
                padding: 0.75rem 1.5rem;
                border-radius: 0.5rem;
                cursor: pointer;
                font-weight: 500;
              ">
              Search
            </button>
            <button
              class="btn-secondary"
              onclick="clearTagsForm()"
              style="
                background: #6b7280;
                color: white;
                border: none;
                padding: 0.75rem 1.5rem;
                border-radius: 0.5rem;
                cursor: pointer;
                font-weight: 500;
              ">
              Clear
            </button>
          </div>
        </div>

        <!-- Search by Thumbnail URL -->
        <div class="search-form" id="thumbnail-url-form" style="display: none">
          <h2 class="search-form-title">üîó Search by Thumbnail URL</h2>
          <p class="search-form-description">
            Enter an S3 thumbnail URL to get the corresponding full-size image.
          </p>

          <div class="url-input-section">
            <label
              for="thumbnailUrl"
              style="display: block; font-weight: 500; margin-bottom: 0.5rem"
              >S3 Thumbnail URL:</label
            >
            <input
              type="url"
              id="thumbnailUrl"
              placeholder="https://xxx.s3.amazonaws.com/bird1-thumb.png"
              style="
                width: 100%;
                padding: 0.75rem;
                border: 2px solid #2563eb;
                border-radius: 0.5rem;
                font-size: 1rem;
              " />
            <small style="color: #6b7280; font-size: 0.875rem"
              >Example: https://xxx.s3.amazonaws.com/bird1-thumb.png</small
            >
          </div>

          <div
            class="search-form-actions"
            style="margin-top: 1.5rem; display: flex; gap: 1rem">
            <button
              class="btn-submit"
              onclick="searchByThumbnailUrl()"
              style="
                background: #059669;
                color: white;
                border: none;
                padding: 0.75rem 1.5rem;
                border-radius: 0.5rem;
                cursor: pointer;
                font-weight: 500;
              ">
              Search
            </button>
            <button
              class="btn-secondary"
              onclick="clearThumbnailForm()"
              style="
                background: #6b7280;
                color: white;
                border: none;
                padding: 0.75rem 1.5rem;
                border-radius: 0.5rem;
                cursor: pointer;
                font-weight: 500;
              ">
              Clear
            </button>
          </div>
        </div>

        <!-- Search by File Upload -->
        <div class="search-form" id="file-upload-form" style="display: none">
          <h2 class="search-form-title">üìÅ Search by File Upload</h2>
          <p class="search-form-description">
            Upload a file to find similar files based on detected bird species.
          </p>

          <div
            style="
              background: #f3f4f6;
              border: 2px dashed #2563eb;
              border-radius: 1rem;
              padding: 2rem;
              text-align: center;
              margin-bottom: 1.5rem;
            ">
            <div style="font-size: 3rem; margin-bottom: 1rem">üìÅ</div>
            <p style="margin-bottom: 0.5rem">Drag & drop file here or</p>
            <button
              onclick="document.getElementById('searchFileInput').click()"
              style="
                background: #2563eb;
                color: white;
                border: none;
                padding: 0.75rem 1.5rem;
                border-radius: 0.5rem;
                cursor: pointer;
                font-weight: 500;
                margin: 0.5rem 0;
              ">
              Choose File
            </button>
            <p style="color: #6b7280; font-size: 0.875rem; margin-top: 0.5rem">
              ‚ö†Ô∏è Note: File will not be stored - used for tag matching only
            </p>
            <input
              type="file"
              id="searchFileInput"
              style="display: none"
              accept=".jpg,.jpeg,.png,.wav,.mp3,.mp4" />
          </div>

          <div
            class="search-form-actions"
            style="margin-top: 1.5rem; display: flex; gap: 1rem">
            <button
              onclick="searchByFileUpload()"
              id="searchByFileBtn"
              disabled
              style="
                background: #6b7280;
                color: white;
                border: none;
                padding: 0.75rem 1.5rem;
                border-radius: 0.5rem;
                cursor: not-allowed;
                font-weight: 500;
              ">
              Search
            </button>
            <button
              onclick="clearFileUploadForm()"
              style="
                background: #6b7280;
                color: white;
                border: none;
                padding: 0.75rem 1.5rem;
                border-radius: 0.5rem;
                cursor: pointer;
                font-weight: 500;
              ">
              Clear
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Sign Out Modal -->
    <div class="modal" id="signOutModal">
      <div class="modal-content">
        <h3 class="modal-title">Are you sure you want to sign out?</h3>
        <div class="modal-buttons">
          <button class="btn-submit" onclick="signOut()">Yes</button>
          <button class="btn-secondary" onclick="hideSignOutModal()">No</button>
        </div>
      </div>
    </div>

    <script src="../shared/js/common.js"></script>
    <script>
      // Enhanced JavaScript with better debugging
      let selectedFiles = [];
      let currentSearchResults = [];
      let searchUploadedFile = null;

      function initializeSearch() {
        console.log("üöÄ INITIALIZING SEARCH FUNCTIONALITY");

        const searchTabs = document.querySelectorAll(".force-visible-links a");
        console.log("üìã Found", searchTabs.length, "search tabs");

        if (searchTabs.length === 0) {
          console.error("‚ùå ERROR: No search tabs found!");
          return;
        }

        searchTabs.forEach((tab, index) => {
          const searchType = tab.getAttribute("data-search-type");
          console.log(`üîó Setting up tab ${index + 1}: ${searchType}`);

          tab.addEventListener("click", (e) => {
            e.preventDefault();
            console.log(`üñ±Ô∏è Tab clicked: ${searchType}`);

            // Remove active class from all tabs
            searchTabs.forEach((t) => t.classList.remove("active"));
            // Add active class to clicked tab
            tab.classList.add("active");

            // Show corresponding search form
            showSearchForm(searchType);
          });
        });

        // Initialize file upload for search
        initializeSearchFileUpload();

        // Show the first form by default
        showSearchForm("tags-counts");
        console.log("‚úÖ Search initialization complete");
      }

      function showSearchForm(searchType) {
        console.log(`üìÑ Showing search form: ${searchType}`);

        // Hide all search forms
        document.querySelectorAll(".search-form").forEach((form) => {
          form.style.display = "none";
        });

        // Show selected form
        const selectedForm = document.getElementById(`${searchType}-form`);
        if (selectedForm) {
          selectedForm.style.display = "block";
          console.log(`‚úÖ Form ${searchType} is now visible`);
        } else {
          console.error(`‚ùå ERROR: Form ${searchType} not found!`);
        }
      }

      function addTagCountPair() {
        console.log("‚ûï Adding new tag-count pair");
        const container = document.getElementById("tagCountPairs");
        const pairDiv = document.createElement("div");
        pairDiv.className = "tag-count-pair";
        pairDiv.innerHTML = `
          <select class="tag-select" style="padding: 0.75rem; border: 2px solid #2563eb; border-radius: 0.5rem; font-size: 1rem; margin-right: 0.5rem;">
            <option value="">Select bird species</option>
            <option value="crow">Crow</option>
            <option value="pigeon">Pigeon</option>
            <option value="sparrow">Sparrow</option>
            <option value="robin">Robin</option>
          </select>
          <input type="number" class="count-input" placeholder="Count" min="1" style="padding: 0.75rem; border: 2px solid #2563eb; border-radius: 0.5rem; font-size: 1rem; width: 100px; margin-right: 0.5rem;">
          <button class="btn-remove-tag" onclick="this.parentElement.remove()" style="background: #ef4444; color: white; border: none; padding: 0.75rem 1rem; border-radius: 0.5rem; cursor: pointer;">√ó Remove</button>
        `;
        pairDiv.style.display = "flex";
        pairDiv.style.alignItems = "center";
        pairDiv.style.gap = "0.5rem";
        pairDiv.style.marginBottom = "1rem";
        container.appendChild(pairDiv);
      }

      function resetTagsCountsForm() {
        console.log("üîÑ Resetting tags & counts form");
        const container = document.getElementById("tagCountPairs");
        container.innerHTML = `
          <div class="tag-count-pair" style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
            <select class="tag-select" style="padding: 0.75rem; border: 2px solid #2563eb; border-radius: 0.5rem; font-size: 1rem;">
              <option value="">Select bird species</option>
              <option value="crow">Crow</option>
              <option value="pigeon">Pigeon</option>
              <option value="sparrow">Sparrow</option>
              <option value="robin">Robin</option>
            </select>
            <input type="number" class="count-input" placeholder="Count" min="1" style="padding: 0.75rem; border: 2px solid #2563eb; border-radius: 0.5rem; font-size: 1rem; width: 100px;">
            <button class="btn-remove-tag" onclick="this.parentElement.remove()" style="background: #ef4444; color: white; border: none; padding: 0.75rem 1rem; border-radius: 0.5rem; cursor: pointer;">√ó Remove</button>
          </div>
        `;
      }

      function clearTagsForm() {
        console.log("üóëÔ∏è Clearing tags form");
        document.getElementById("speciesSelect").selectedIndex = -1;
      }

      function clearThumbnailForm() {
        console.log("üóëÔ∏è Clearing thumbnail form");
        document.getElementById("thumbnailUrl").value = "";
      }

      function clearFileUploadForm() {
        console.log("üóëÔ∏è Clearing file upload form");
        document.getElementById("searchFileInput").value = "";
        document.getElementById("searchByFileBtn").disabled = true;
        document.getElementById("searchByFileBtn").style.background = "#6b7280";
        document.getElementById("searchByFileBtn").style.cursor = "not-allowed";
        searchUploadedFile = null;
      }

      function searchByTagsAndCounts() {
        alert(
          "üîç Search by Tags & Counts - This will connect to your backend API"
        );
      }

      function searchByTags() {
        alert("üîç Search by Tags - This will connect to your backend API");
      }

      function searchByThumbnailUrl() {
        alert(
          "üîç Search by Thumbnail URL - This will connect to your backend API"
        );
      }

      function searchByFileUpload() {
        alert(
          "üîç Search by File Upload - This will connect to your backend API"
        );
      }

      function initializeSearchFileUpload() {
        const fileInput = document.getElementById("searchFileInput");
        if (fileInput) {
          fileInput.addEventListener("change", (e) => {
            const file = e.target.files[0];
            if (file) {
              console.log("üìÅ File selected for search:", file.name);
              searchUploadedFile = file;
              const btn = document.getElementById("searchByFileBtn");
              btn.disabled = false;
              btn.style.background = "#059669";
              btn.style.cursor = "pointer";
            }
          });
        }
      }

      function showSignOutModal() {
        const modal = document.getElementById("signOutModal");
        if (modal) {
          modal.classList.add("active");
        }
      }

      function hideSignOutModal() {
        const modal = document.getElementById("signOutModal");
        if (modal) {
          modal.classList.remove("active");
        }
      }

      function signOut() {
        console.log("üëã Signing out...");
        hideSignOutModal();
        // Add your sign out logic here
      }

      // Initialize on page load
      document.addEventListener("DOMContentLoaded", () => {
        console.log("üåü PAGE LOADED - Starting initialization");
        initializeSearch();
      });
    </script>
  </body>
</html>
